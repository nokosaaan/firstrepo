# OP コマンド使用ガイド

このドキュメントは、`firstrepo/discordbot.py` に実装されている `!op` コマンドの使い方をまとめたものです。

## 概要
`!op` は、データファイル（`data_c.json`）から ULT / MAS 譜面を集計し、各譜面の Max OP = (定数 + 3) * 5 を合計して表示します。さらに、指定したパーセント間の OP 差分計算や、目標を達成するための複数の増分プラン（AJ/FC/AJC/スコアの組合せ）を生成します。

## 呼び出しスタイル
1. Discord コマンド
   - 例: `!op <flag-or-name> [names...] [options...]`
   - 引数は shlex ベースでパースされるため、空白を含むタイトルは `"..."` で囲んで指定できます。

## 呼び出しスタイル
1. 内部呼び出し（プログラムから）
   - `op(ctx, json_data, op2)`
2. Discord コマンド
   - 例: `!op <flag-or-name> [names...] [options...]`
   - 引数は shlex ベースでパースされるため、空白を含むタイトルは `"..."` で囲んで指定できます。

## 主なオプション（コマンドで使用可能）
- 除外フラグ
  - 最初の引数に `true` を置くと除外モードになります（`!op true ...`）。
  - 例: `!op true "Song A" "Song B"`（これらの曲を除外）
- プリセットグループ
  - `ultima` が事前定義されています。
  - 例: `!op true ultima`（`ultima` グループを除外）

### 解析／提案用オプション
- パーセント指定
  - トークン: `pct`（コードは `pct` を優先して検出します）
  - 続けて 2 つの数値を与えます（開始%, 目標%）。値は `0-1` でも `0-100` でも可（1より大きければ100分率と見なします）。
  - 例: `!op false pct 99.01 99.02`
- AJ 最大定数制約（ajmax）
  - トークン: `ajmax`
  - 直後に浮動小数点を指定。AJ（判定強化）の候補にできる譜面の上限定数を指定します。
  - 例: `!op false ajmax 12.5 pct 99.01 99.02`
- 割当候補定数範囲（minconst / maxconst）
  - トークン: `minconst`, `maxconst`
  - `minconst` / `maxconst` を使って、割当候補（AJ/FC/AJC/Score 各候補を選ぶ元のプール）をフィルタします。
  - 例: `!op false minconst 12.0 maxconst 13.5 pct 99.01 99.02`

## 代表定数と割当挙動
- 実装では `minconst` / `maxconst` を使用して代表定数（rep_const）を決定します:
  - `minconst` と `maxconst` の両方を指定: 代表定数 = (min + max) / 2
  - 片方のみ指定: 代表定数 = 指定した値
  - 両方未指定: 提案（suggestion）機能はエラーとなり、`minconst` か `maxconst` のいずれかを指定する必要があります（増分提案は動作しません）

## AJ 候補のフィルタ挙動（重要）
- `ajmax` を指定すると、AJ 候補として選べる曲は `minconst`（もし指定済み）以上かつ `ajmax` 以下の定数に限定されます。
- 候補が不足する場合のフォールバック:
  - まず条件を満たす候補をすべて使い、足りない分は残りのプール（選択済みを除く）から補填します。
  - それでも不足する場合は、全プールからランダム補填（重複許容）します。
  - 条件に一致する候補がゼロだった場合は、従来どおり全プールからランダムに候補を選びます。

## 出力内容
 - チャート数のサマリ（MAS / ULT チャート数）
 - 計算対象曲数・合計 Max OP
 - （pct 指定があれば）現在の OP 値・目標 OP 値・必要な OP 差
 - 最小化プラン（上位 3 案まで）
   - 各案について: コスト、増分（OP）、AJ/FC/AJC/スコア増加の目安
   - 各案ごとに、フィルタ適用後のプールの中からランダムに曲名を割り当てた「実施候補曲」リストを表示
 - MAS と選定結果の差分リスト（診断用）

## 例（そのまま Discord に貼って使えるコマンド）
 - 単純に集計のみ（除外なし）
   - `!op sum`
 - 除外モードで `ultima` を除外
   - `!op true ultima`
 - 99.01% -> 99.02% の差分計算と増分提案
   - `!op false pct 99.01 99.02`
 - 代表譜面定数（min/max）を指定して提案
   - `!op false minconst 12.0 maxconst 13.5 pct 99.01 99.02`
 - AJ 候補を定数 12.5 以下に制限して提案
   - `!op false ajmax 12.5 pct 99.01 99.02`
 - 複数オプションを組み合わせた例
   - `!op true "Song A" "Song B" pct 99.01 99.02 minconst 12.0 maxconst 13.5 ajmax 12.5`

## 実装上の注意（既知の仕様と限界）
 - タイトルの一致は文字列ベースです。表記ゆれがあると別タイトルとして扱われます。
 - 除外モードで ULT を除外した場合、代替の MAS は「最初に見つかった」MASを使います（将来的には最大定数のMASに変更することを推奨します）。
 - 最小化プランはヒューリスティックな探索（コスト関数＋上位候補抽出）に基づいています。コスト比率や優先順位はソース内で調整可能です。

## 追加可能な改善案（要望例）
 - 割当ロジックをランダムではなく優先ルールで決める（定数高優先／既にAJがない曲優先など）
 - 各案ごとに曲別の必要スコア（500点ステップ換算）を表示
 - `ajmax` の代わりに「AJを許容する最大曲数」などUI寄りの制御

---

必要であれば、この `OP_COMMANDS.md` をさらに整形し、README に組み込むか Discord の固定メッセージ用に短縮版を作ります。どの形式がよいですか？
  - 単純に集計のみ（除外なし）
    - `!op false`
  - 除外モードで `ultima` を除外
    - `!op true ultima`
  - 99.01% -> 99.02% の差分計算と増分提案
    - `!op false pct 99.01 99.02`
  - 代表譜面定数（min/max）を指定して提案
    - `!op false minconst 12.0 maxconst 13.5 pct 99.01 99.02`
  - AJ 候補を定数 12.5 以下に制限して提案
    - `!op false ajmax 12.5 pct 99.01 99.02`
  - 複数オプションを組み合わせた例
    - `!op true "Song A" "Song B" pct 99.01 99.02 minconst 12.0 maxconst 13.5 ajmax 12.5`

  ## 実装上の注意（既知の仕様と限界）
  - タイトルの一致は文字列ベースです。表記ゆれがあると別タイトルとして扱われます。
  - 除外モードで ULT を除外した場合、代替の MAS は「最初に見つかった」MASを使います（将来的には最大定数のMASに変更することを推奨します）。
  - 最小化プランはヒューリスティックな探索（コスト関数＋上位候補抽出）に基づいています。コスト比率や優先順位はソース内で調整可能です。

  ## 追加可能な改善案（要望例）
  - 割当ロジックをランダムではなく優先ルールで決める（定数高優先／既にAJがない曲優先など）
  - 各案ごとに曲別の必要スコア（500点ステップ換算）を表示
  - `ajmax` の代わりに「AJを許容する最大曲数」などUI寄りの制御

  ---

  必要であれば、この `OP_COMMANDS.md` をさらに整形し、README に組み込むか Discord の固定メッセージ用に短縮版を作ります。どの形式がよいですか？
