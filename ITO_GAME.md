# ITO（イートー）ゲーム — 使い方とコマンド一覧

このファイルは `discordbot.py` に実装した ITO（0〜100 の数値カードを使う心理ゲーム）機能の使い方をまとめたものです。

## 概要
ITO は次の手順で行います。参加者全員に 0〜100 の数字（「秘匿値」）が配られます。司会（またはおみくじbot）がランダムにお題（トピック）を提示し、参加者は自分の秘匿値を基準にお題に対する回答（口頭やチャット）を行い、最終的に各自が「発表する数字」を提出します。ゲームの目的は、提出された数字が小さい順（厳密な昇順）になっているかを判定し、条件を満たせばクリアとするものです。

本実装では、以下を満たします:
- `!ito start` でゲーム開始（トピックランダム選択）
- `!ito num` で個別に 0〜100 の数字を配布（ユーザーのみが閲覧できるようにプライベートスレッドかDMで送信）
- `!ito submit <数値>` で発表（提出）
- `!ito status` でゲームの進行状況（配布済み・提出済み）を確認（秘匿値は表示しない）
- `!ito end` でゲーム終了、秘匿値・提出値を公開し、提出値が厳密昇順ならクリア表示

## 実行フロー（オペレーション）
1. 司会または任意のユーザーがチャンネルで `!ito start` を実行します。
   - ボットはトピック（お題）をランダムに選び、チャンネルに告知します。
   - 同時にそのギルド（サーバー）用のゲーム状態が初期化されます。

2. 参加者は自分の秘匿値を受け取るためにチャンネルで `!ito num` を実行します。
   - ボットはランダムに 0〜100 の整数を割り当てます。
   - 可能であれば「プライベートスレッド」を作成してそのスレッド内で番号を送信します（スレッド作成にはボットの権限が必要）。
   - プライベートスレッドが作れない場合はボットが DM で番号を送ります（DM が受け取れる設定である必要があります）。
   - 他のユーザーには割当番号は見えません。

3. 参加者は議論・相談を行い、口頭やチャットで自分の発表内容を共有して構いません（ただし秘匿値そのものは公開しない運用を推奨）。

4. 各参加者は最終的に `!ito submit <数値>` を使い自分が発表する数字を提出します（0〜100 の整数）。
   - 提出値はゲームに記録されます。

5. 進行中に状況を確認するには `!ito status` を使います。
   - 現在のトピック、配布済みプレイヤー（メンション）、提出済みプレイヤー（メンション）が表示されます。
   - 秘匿値は決してこのコマンドで表示されません。

6. 司会が `!ito end` を実行するとゲームは終了します。
   - ボットは各参加者の「配布番号（秘匿値）」と「提出値」を公開します。
   - 提出された値（提出したユーザーのみ対象）の数値列が厳密に昇順（各要素が次より小さい）になっているかを判定し、クリア/失敗 を表示します。
   - ゲーム状態はリセット（メモリ上のデータをクリア）されます。

## コマンド詳細（例つき）
- `!ito start`
  - 説明: ITOゲームを開始し、ランダムなお題をチャンネルに投稿します。
  - 例: `!ito start`
  - 返信例: "ITOゲーム開始！ テーマ: 今日の気分を0~100で表すと？\n参加者は `!ito num` を使って..."

- `!ito num`
  - 説明: 自分だけに見える形で 0〜100 の整数を受け取ります。可能ならプライベートスレッドを作成して送信。失敗時は DM へ。
  - 例: `!ito num`
  - 返信例: チャンネル上: "@ユーザー に個別のITO番号を送信しました（プライベートスレッドを作成しました）。" または DM 内に "あなたのITOの数字は: 73 です。"

- `!ito submit <数値>`
  - 説明: 自分の発表数字を記録します（0〜100 の整数）。
  - 例: `!ito submit 42`
  - 返信例: "@ユーザー の提出を記録しました。値: 42"

- `!ito status`
  - 説明: 現在のトピック、配布済み・提出済みプレイヤー一覧（メンション）を表示します。秘匿値は表示されません。
  - 例: `!ito status`
  - 返信例: 複数行でトピック、配布済みユーザー、提出済みユーザーを表示。

- `!ito end`
  - 説明: ゲームを終了し、配布番号と提出を公開。提出された数値が厳密昇順ならクリアと表示します。状態はリセットされます。
  - 例: `!ito end`
  - 返信例: 
```
ITO ゲーム終了 - トピック: 今日の気分を0~100で表すと？
参加者一覧:
@A - 配布番号: 73 - 提出: 30
@B - 配布番号: 21 - 提出: 40
@C - 配布番号: 55 - 提出: 60
結果: 提出された数字は厳密に昇順です — クリア！
```

> 注: 提出がひとつも無い場合や参加者が居ない場合はその旨を表示します。

## 実装上の注意点 / 必要な権限
- スレッド作成/参加のために以下の権限が必要になる場合があります（サーバー設定による）:
  - Manage Threads / Create Public/Private Threads
  - Send Messages
- DM に送るフォールバックは、ユーザーが DM を受け取れる設定（相互フォロー、サーバー設定など）である必要があります。
- 現状の実装はメモリ内（プロセスの変数）にのみ状態を保存します。ボットが再起動するとゲーム状態は失われます。永続化が必要であればファイル保存や簡易 DB（JSON 保存、sqlite など）を追加できます。

## 「クリア条件」の扱い（現状の実装）
- 既定の判定は「提出したプレイヤーたちの提出値が厳密に昇順（strictly increasing）であること」です。具体的には提出値リスト v_1, v_2, ... があり、v_i < v_{i+1} が全て成り立てばクリア扱いです。
- 実装上、提出値は `!ito submit` 呼び出しで記録された順（内部辞書の挿入順）を元に評価されます。提出順での評価が不要で、代わりに例えば "提出値を値でソートして昇順になっているか"、または "配布番号に対応した昇順" のように判定したい場合は、ルールを教えていただければコードを修正できます。

## 変更点（実装ファイル）
- `discordbot.py` に ITO 機能を追加しました（ゲーム状態管理・コマンド群）。
- 変更場所: `discordbot.py` の Flask サーバー宣言の直前に ITO 実装が挿入されています。

## 将来的な改善案
- 管理者（またはゲーム開始者のみ）が `!ito end` を呼べるよう権限制御を追加。
- 永続化（ファイル/DB）を追加して再起動耐性を持たせる。
- トピックの追加/削除コマンド（`!ito topic add` / `!ito topic list`）や、カスタムトピックの指定。
- 各参加者の提出タイムスタンプを記録して "提出順" を正確に反映する。
- テストスクリプトやドキュメント内にサンプルの流れ (例: 3 人でのプレイ) を追加。